# This workflow is triggered after a PR is merged or when the title of a PR is
# changed post merge
name: "Label for Release Notes"


on:
  pull_request_target:
    types:
      - closed
      - edited # interested in post merge title changes

jobs:
  ###################################################
  # Assign labels on merge to generate Release Notes
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-your-workflow-when-a-pull-request-merges
  ###################################################
  if_merged:
    name: "PR was merged"
    if: (github.event.pull_request.merged == true) && ( github.event.action == 'closed' || (github.event.action == 'edited' && github.event.changes.title != null) )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v5
      - name: Label merged PR for release notes
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Extract type from PR title (feat, fix, etc.)
          TYPE=$(echo "$PR_TITLE" | grep -oE '^(feat|fix|cut|doc|ci|bump|test|refactor|revert|make|chore)' || echo "")

          # Map PR types to release note labels
          case "$TYPE" in
            "feat")
              LABEL="rn:enhancement"
              DESCRIPTION="Enhancement or new feature"
              COLOR="0E8A16"
              ;;
            "fix")
              LABEL="rn:bugfix"
              DESCRIPTION="Bug fix"
              COLOR="D93F0B"
              ;;
            "doc")
              LABEL="rn:documentation"
              DESCRIPTION="Documentation changes"
              COLOR="5319E7"
              ;;
            "ci"|"test"|"refactor"|"make"|"chore")
              LABEL="rn:maintenance"
              DESCRIPTION="Maintenance and internal changes"
              COLOR="FBCA04"
              ;;
            "bump")
              LABEL="rn:dependency"
              DESCRIPTION="Dependency updates"
              COLOR="0366D6"
              ;;
            *)
              LABEL="rn:other"
              DESCRIPTION="Other changes"
              COLOR="7057FF"
              ;;
          esac

          # Create label if it doesn't exist
          gh label create "$LABEL" \
            --description "$DESCRIPTION" \
            --color "$COLOR" \
            --force || true

          # Add label to PR
          gh pr edit "$PR_NUMBER" \
            --add-label "$LABEL"

          echo "Added label: $LABEL to PR #$PR_NUMBER"
