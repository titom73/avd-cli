---
title: AVD CLI Deploy EOS Command Specification
version: 1.1
date_created: 2025-11-10
last_updated: 2025-11-11
owner: AVD CLI Development Team
tags: [tool, deploy, eos, eapi, configuration-management, network-automation]
---

# Introduction

This specification defines the `avd-cli deploy eos` command for pushing device configurations from an AVD inventory to Arista EOS devices using eAPI. This command enables automated configuration deployment with support for different merge strategies, dry-run validation, and progress tracking.

## 1. Purpose & Scope

### Purpose

Define the functional requirements, technical architecture, and implementation patterns for the `avd-cli deploy eos` command that deploys generated configurations to Arista EOS devices via eAPI.

### Scope

- Command interface design and option structure
- Configuration deployment strategies (replace vs. add/delete modes)
- Dry-run and diff functionality for validation
- Authentication and connection management from Ansible inventory
- Progress tracking and status reporting
- Error handling and rollback strategies
- Async/parallel deployment for performance optimization

### Audience

- Development team implementing the deploy command
- AI coding assistants (GitHub Copilot)
- Code reviewers and maintainers
- Network engineers deploying configurations

### Assumptions

- Users have generated configurations using `avd-cli generate` command
- Target EOS devices are reachable via eAPI (HTTPS)
- Ansible inventory contains valid `ansible_user` and `ansible_password` credentials
- Generated configuration files follow the naming convention: `<hostname>.cfg`
- Users understand the difference between replace and merge configuration strategies

## 2. Definitions

- **eAPI**: Arista EOS API - RESTful API for managing EOS devices over HTTPS
- **SSL Certificate Verification**: Process of validating the authenticity of the device's SSL certificate during eAPI connection. Disabled by default to support lab environments with self-signed certificates, can be enabled with `--verify-ssl` for production
- **Replace Mode**: Configuration deployment that replaces the entire running configuration with the new configuration
- **Add/Delete Mode**: Configuration deployment that merges changes incrementally (adds new lines, removes deleted lines)
- **Dry-Run Mode**: Validation mode that shows configuration differences without applying changes
- **Diff Mode**: Display mode that shows configuration changes during deployment
- **aio-eapi**: Asynchronous Python library for Arista eAPI interactions (https://github.com/jeremyschulman/aio-eapi)
- **pyeapi**: Synchronous Python library for Arista eAPI (https://github.com/arista-eosplus/pyeapi)
- **Running Configuration**: The currently active configuration on an EOS device
- **Intended Configuration**: The configuration file generated by `avd-cli generate` to be deployed
- **Configuration Session**: EOS feature for staging and committing configuration changes atomically
- **ansible_user**: Ansible inventory variable containing the username for device authentication
- **ansible_password**: Ansible inventory variable containing the password for device authentication
- **Progress Bar**: Visual indicator showing deployment progress across multiple devices

## 3. Requirements, Constraints & Guidelines

### Functional Requirements

- **REQ-001**: Command shall deploy configurations from inventory to EOS devices using eAPI
- **REQ-002**: Command shall accept inventory directory path as mandatory parameter
- **REQ-003**: Command shall optionally accept configurations directory path (default: `<inventory>/intended/configs`)
- **REQ-004**: Command shall extract `ansible_user` and `ansible_password` from Ansible inventory (group_vars or host_vars)
- **REQ-005**: Command shall support replace mode as default deployment strategy
- **REQ-006**: Command shall support add/delete mode via `--merge` option
- **REQ-007**: Command shall support dry-run mode via `--dry-run` flag to show diffs without applying
- **REQ-008**: Command shall support diff mode via `--diff` flag to show changes during deployment
- **REQ-009**: Command shall map Ansible hostname to configuration file: `<hostname>.cfg`
- **REQ-010**: Command shall display per-host deployment status during execution
- **REQ-011**: Command shall display global progress bar for batch deployments
- **REQ-012**: Command shall support limiting deployment to specific groups via `--limit-to-groups`
- **REQ-013**: Command shall use async/parallel connections for performance optimization
- **REQ-014**: Command shall handle connection failures gracefully with clear error messages
- **REQ-015**: Command shall validate configuration files exist before attempting deployment
- **REQ-016**: Command shall support environment variables for all options (AVD_CLI_ prefix)
- **REQ-017**: Command shall provide deployment summary with success/failure statistics

### Technical Requirements

- **TEC-001**: Implementation shall use aio-eapi library for async eAPI connections
- **TEC-002**: Implementation shall support falling back to pyeapi if aio-eapi is unavailable
- **TEC-003**: Implementation shall use asyncio for concurrent device deployments
- **TEC-004**: Implementation shall use Rich library for progress bars and status display
- **TEC-005**: Implementation shall handle SSL certificate validation with configurable skip
- **TEC-006**: Implementation shall implement connection timeout and retry logic
- **TEC-007**: Implementation shall use Click framework consistent with existing commands
- **TEC-008**: Implementation shall use type hints for all public APIs
- **TEC-009**: Implementation shall follow NumPy-style docstring format
- **TEC-010**: Implementation shall use pathlib.Path for all file operations
- **TEC-011**: Implementation shall support both JSON-RPC and CLI API transport methods
- **TEC-012**: Implementation shall implement secure credential handling (no logging)

### Security Requirements

- **SEC-001**: Credentials shall never be logged or displayed in output
- **SEC-002**: HTTPS shall be used for all eAPI connections
- **SEC-003**: SSL certificate validation shall be configurable, disabled by default for lab compatibility
- **SEC-003.1**: When SSL verification is enabled (--verify-ssl), the system shall validate the device's SSL certificate against trusted CA certificates
- **SEC-003.2**: When SSL verification is disabled (default), no certificate validation is performed to support self-signed certificates
- **SEC-003.3**: Users deploying to production should use --verify-ssl flag for enhanced security
- **SEC-004**: Credentials shall be read from inventory files with appropriate file permissions
- **SEC-005**: Connection credentials shall not be stored in command history or cache
- **SEC-006**: Diff output shall not contain sensitive data (passwords, keys)

### Quality Requirements

- **QUA-001**: Code coverage for deploy module shall exceed 80%
- **QUA-002**: All public functions shall have comprehensive docstrings
- **QUA-003**: Dry-run mode shall produce accurate diffs matching actual deployment results
- **QUA-004**: Progress indicators shall update in real-time during deployment
- **QUA-005**: Error messages shall be clear, actionable, and include device context
- **QUA-006**: Command execution time shall scale linearly with device count (parallel deployment)

### Constraints

- **CON-001**: Deployment requires network connectivity to target devices
- **CON-002**: Devices must have eAPI enabled and accessible
- **CON-003**: User credentials must have sufficient privileges for configuration changes
- **CON-004**: Configuration files must be valid EOS syntax
- **CON-005**: Replace mode requires devices to support configuration replace operation
- **CON-006**: Maximum concurrent connections should be configurable to avoid overwhelming devices
- **CON-007**: Deployment operations are not transactional across multiple devices

### Guidelines

- **GUD-001**: Use dry-run mode before production deployments to validate changes
- **GUD-002**: Start with small device groups when testing deployment workflows
- **GUD-003**: Ensure backup configurations exist before performing replace operations
- **GUD-004**: Monitor device status during deployment for early error detection
- **GUD-005**: Use merge mode for incremental changes, replace mode for full synchronization
- **GUD-006**: Configure appropriate timeouts based on configuration size and network latency
- **GUD-007**: Implement proper logging for audit trail of configuration changes
- **GUD-008**: Enable SSL certificate verification (--verify-ssl) in production environments with proper CA-signed certificates
- **GUD-009**: Default behavior (no SSL verification) is suitable for lab/dev environments with self-signed certificates

### Patterns

- **PAT-001**: Use async context managers for eAPI connection lifecycle
- **PAT-002**: Implement retry logic with exponential backoff for transient failures
- **PAT-003**: Use semaphore to limit concurrent device connections
- **PAT-004**: Implement graceful degradation if async library unavailable
- **PAT-005**: Use Rich table display for deployment summary without per-device loading bars
- **PAT-006**: Follow existing CLI command structure and option naming conventions

### User Experience Requirements

- **UXR-001**: CLI output shall use Rich library for formatted tables without per-device progress bars
- **UXR-002**: Deployment status shall update in real-time showing current device being processed
- **UXR-003**: Status indicators shall use consistent symbols (✓ success, ✗ failure, ℹ info)
- **UXR-004**: Deployment summary shall be displayed in table format with clear metrics including diff statistics
- **UXR-005**: Diff statistics in summary table shall be color-coded: green for additions (+), red for deletions (-)
- **UXR-006**: Summary table shall include columns: Hostname, Status, Duration, Diff (+/-)

## 4. Interfaces & Data Contracts

### Command Interface

#### Deploy Command Group

```python
@cli.group()
@click.pass_context
def deploy(ctx: click.Context) -> None:
    """Deploy configurations to network devices.

    This command group provides subcommands for deploying generated
    configurations to target devices.

    Examples
    --------
    Deploy configurations to EOS devices:

        $ avd-cli deploy eos -i ./inventory

    Dry-run to preview changes:

        $ avd-cli deploy eos -i ./inventory --dry-run

    Deploy with diff output:

        $ avd-cli deploy eos -i ./inventory --diff
    """
    pass
```

#### Deploy EOS Subcommand

```python
@deploy.command('eos')
@click.option(
    '--inventory-path',
    '-i',
    type=click.Path(exists=True, file_okay=False, path_type=Path),
    required=True,
    envvar='AVD_CLI_INVENTORY_PATH',
    show_envvar=True,
    help='Path to AVD inventory directory'
)
@click.option(
    '--configs-path',
    '-c',
    type=click.Path(exists=True, file_okay=False, path_type=Path),
    default=None,
    envvar='AVD_CLI_CONFIGS_PATH',
    show_envvar=True,
    help='Path to configurations directory (default: <inventory>/intended/configs)'
)
@click.option(
    '--merge/--replace',
    'merge_mode',
    default=False,
    envvar='AVD_CLI_MERGE_MODE',
    show_envvar=True,
    help='Use merge mode (add/delete) instead of replace mode'
)
@click.option(
    '--dry-run',
    is_flag=True,
    default=False,
    envvar='AVD_CLI_DRY_RUN',
    show_envvar=True,
    help='Show configuration diffs without applying changes'
)
@click.option(
    '--diff',
    is_flag=True,
    default=False,
    envvar='AVD_CLI_SHOW_DIFF',
    show_envvar=True,
    help='Display configuration diffs during deployment'
)
@click.option(
    '--limit-to-groups',
    '-l',
    multiple=True,
    envvar='AVD_CLI_LIMIT_TO_GROUPS',
    show_envvar=True,
    help='Limit deployment to specific device groups (repeatable)'
)
@click.option(
    '--max-concurrent',
    type=int,
    default=10,
    envvar='AVD_CLI_MAX_CONCURRENT',
    show_envvar=True,
    help='Maximum concurrent device connections (default: 10)'
)
@click.option(
    '--timeout',
    type=int,
    default=30,
    envvar='AVD_CLI_TIMEOUT',
    show_envvar=True,
    help='Connection timeout in seconds (default: 30)'
)
@click.option(
    '--verify-ssl',
    is_flag=True,
    default=False,
    envvar='AVD_CLI_VERIFY_SSL',
    show_envvar=True,
    help='Enable SSL certificate verification (recommended for production)'
)
@click.pass_context
def deploy_eos(
    ctx: click.Context,
    inventory_path: Path,
    configs_path: Optional[Path],
    merge_mode: bool,
    dry_run: bool,
    diff: bool,
    limit_to_groups: tuple[str, ...],
    max_concurrent: int,
    timeout: int,
    verify_ssl: bool
) -> None:
    """Deploy configurations to Arista EOS devices via eAPI.

    This command pushes generated configurations from the inventory to EOS
    devices using eAPI. It supports both replace and merge deployment modes,
    with dry-run capability for validation.

    Configuration files are expected to be in <inventory>/intended/configs/
    by default, with filenames matching the Ansible hostname: <hostname>.cfg

    Authentication credentials (ansible_user, ansible_password) are read from
    the Ansible inventory (group_vars or host_vars).

    By default, SSL certificate verification is disabled to support lab/dev
    environments with self-signed certificates. Use --verify-ssl flag for
    production deployments with proper CA-signed certificates.

    All options can be provided via environment variables with AVD_CLI_ prefix.
    Command-line arguments take precedence over environment variables.

    Examples
    --------
    Deploy all configurations with replace mode (default):

        $ avd-cli deploy eos -i ./inventory

    Deploy with custom configs directory:

        $ avd-cli deploy eos -i ./inventory -c ./custom-configs

    Dry-run to preview changes without applying:

        $ avd-cli deploy eos -i ./inventory --dry-run

    Deploy with merge mode and show diffs:

        $ avd-cli deploy eos -i ./inventory --merge --diff

    Deploy to specific groups only:

        $ avd-cli deploy eos -i ./inventory -l spine -l leaf

    Enable SSL verification for production:

        $ avd-cli deploy eos -i ./inventory --verify-ssl

    Using environment variables:

        $ export AVD_CLI_INVENTORY_PATH=./inventory
        $ export AVD_CLI_DRY_RUN=true
        $ avd-cli deploy eos

    Parameters
    ----------
    inventory_path : Path
        Path to AVD inventory directory containing Ansible inventory files
    configs_path : Optional[Path]
        Path to directory containing configuration files to deploy.
        Defaults to <inventory_path>/intended/configs
    merge_mode : bool
        If True, use merge (add/delete) mode. If False, use replace mode
    dry_run : bool
        If True, show diffs without applying changes
    diff : bool
        If True, display diffs during deployment (ignored if dry_run=True)
    limit_to_groups : tuple[str, ...]
        Limit deployment to devices in specified groups
    max_concurrent : int
        Maximum number of concurrent device connections
    timeout : int
        Connection timeout in seconds
    verify_ssl : bool
        Enable SSL certificate verification (recommended for production,
        disabled by default for lab/dev compatibility)
    """
```

### Data Models

```python
from dataclasses import dataclass
from enum import Enum
from pathlib import Path
from typing import Optional


class DeploymentMode(Enum):
    """Deployment mode enumeration."""
    REPLACE = "replace"
    MERGE = "merge"


class DeploymentStatus(Enum):
    """Deployment status enumeration."""
    PENDING = "pending"
    CONNECTING = "connecting"
    DEPLOYING = "deploying"
    SUCCESS = "success"
    FAILED = "failed"
    SKIPPED = "skipped"


@dataclass
class DeviceCredentials:
    """Device authentication credentials."""
    username: str
    password: str
    enable_password: Optional[str] = None


@dataclass
class DeploymentTarget:
    """Target device for configuration deployment."""
    hostname: str
    mgmt_ip: str
    config_file: Path
    credentials: DeviceCredentials
    groups: list[str]


@dataclass
class DeploymentResult:
    """Result of a single device deployment."""
    hostname: str
    status: DeploymentStatus
    diff: Optional[str] = None
    error: Optional[str] = None
    duration: float = 0.0
    changes_applied: bool = False
    diff_lines_added: int = 0  # Number of lines added in diff
    diff_lines_removed: int = 0  # Number of lines removed in diff


@dataclass
class DeploymentSummary:
    """Summary of deployment batch."""
    total_devices: int
    successful: int
    failed: int
    skipped: int
    results: list[DeploymentResult]
    total_duration: float
```

### eAPI Connection Interface

```python
from typing import Protocol, Optional
from dataclasses import dataclass


@dataclass
class EapiConfig:
    """eAPI connection configuration."""
    host: str
    username: str
    password: str
    protocol: str = "https"
    port: int = 443
    timeout: int = 30
    verify_ssl: bool = False  # SSL verification disabled by default (lab/dev friendly)
    # Set verify_ssl=True for production with proper CA-signed certificates


class EapiClient(Protocol):
    """Protocol for eAPI client implementations."""

    async def connect(self) -> None:
        """Establish connection to device."""
        ...

    async def disconnect(self) -> None:
        """Close connection to device."""
        ...

    async def get_running_config(self) -> str:
        """Retrieve running configuration.

        Returns
        -------
        str
            Current running configuration as text
        """
        ...

    async def get_config_diff(
        self,
        intended_config: str,
        mode: DeploymentMode = DeploymentMode.REPLACE
    ) -> str:
        """Generate configuration diff.

        Parameters
        ----------
        intended_config : str
            Target configuration content
        mode : DeploymentMode
            Deployment mode (replace or merge)

        Returns
        -------
        str
            Unified diff between running and intended config
        """
        ...

    async def apply_config(
        self,
        intended_config: str,
        mode: DeploymentMode = DeploymentMode.REPLACE,
        dry_run: bool = False
    ) -> DeploymentResult:
        """Apply configuration to device.

        Parameters
        ----------
        intended_config : str
            Configuration content to apply
        mode : DeploymentMode
            Deployment mode (replace or merge)
        dry_run : bool
            If True, validate only without applying

        Returns
        -------
        DeploymentResult
            Result of deployment operation
        """
        ...
```

### Inventory Credential Extraction

```python
from typing import Dict, Any, Optional
from pathlib import Path
import yaml


def extract_device_credentials(
    inventory_path: Path,
    hostname: str,
    groups: list[str]
) -> DeviceCredentials:
    """Extract device credentials from Ansible inventory.

    Searches for ansible_user and ansible_password in host_vars
    and group_vars, with host_vars taking precedence.

    Parameters
    ----------
    inventory_path : Path
        Path to inventory directory
    hostname : str
        Device hostname to extract credentials for
    groups : list[str]
        List of groups the device belongs to

    Returns
    -------
    DeviceCredentials
        Extracted credentials

    Raises
    ------
    ValueError
        If required credentials are not found
    """
    credentials: Dict[str, Any] = {}

    # Check group_vars (from least to most specific)
    for group in groups:
        group_vars_file = inventory_path / "group_vars" / f"{group}.yml"
        if group_vars_file.exists():
            with open(group_vars_file) as f:
                group_data = yaml.safe_load(f) or {}
                if "ansible_user" in group_data:
                    credentials["username"] = group_data["ansible_user"]
                if "ansible_password" in group_data:
                    credentials["password"] = group_data["ansible_password"]

    # Check host_vars (highest precedence)
    host_vars_file = inventory_path / "host_vars" / f"{hostname}.yml"
    if host_vars_file.exists():
        with open(host_vars_file) as f:
            host_data = yaml.safe_load(f) or {}
            if "ansible_user" in host_data:
                credentials["username"] = host_data["ansible_user"]
            if "ansible_password" in host_data:
                credentials["password"] = host_data["ansible_password"]

    # Validate required credentials exist
    if "username" not in credentials:
        raise ValueError(
            f"ansible_user not found for device {hostname} "
            f"in group_vars or host_vars"
        )
    if "password" not in credentials:
        raise ValueError(
            f"ansible_password not found for device {hostname} "
            f"in group_vars or host_vars"
        )

    return DeviceCredentials(
        username=credentials["username"],
        password=credentials["password"]
    )
```

## 5. Acceptance Criteria

### Core Functionality

- **AC-001**: Given a valid inventory with credentials, When user runs `avd-cli deploy eos -i <inventory>`, Then configurations are successfully deployed to all devices using replace mode
- **AC-002**: Given configurations in custom directory, When user runs `avd-cli deploy eos -i <inventory> -c <configs>`, Then configurations from custom directory are deployed
- **AC-003**: Given merge mode flag, When user runs `avd-cli deploy eos -i <inventory> --merge`, Then configurations are deployed using add/delete merge strategy
- **AC-004**: Given dry-run flag, When user runs `avd-cli deploy eos -i <inventory> --dry-run`, Then diffs are displayed but no changes are applied to devices
- **AC-005**: Given diff flag, When user runs `avd-cli deploy eos -i <inventory> --diff`, Then configuration diffs are displayed during deployment
- **AC-006**: Given group limit, When user runs `avd-cli deploy eos -i <inventory> -l spine`, Then only devices in spine group are deployed
- **AC-007**: Given missing config file, When deployment is attempted, Then clear error message is displayed and deployment fails gracefully
- **AC-008**: Given invalid credentials, When connection is attempted, Then authentication error is displayed with hostname context
- **AC-009**: Given unreachable device, When connection is attempted, Then timeout error is displayed with hostname and retry information

### Progress and Status Reporting

- **AC-010**: Given multiple devices, When deployment completes, Then summary table displays statistics (total, success, failed, duration) without per-device progress bars
- **AC-011**: Given deployment in progress, When each device completes, Then per-device status is displayed in real-time (success/failed/pending)
- **AC-012**: Given deployment complete with diff output, When summary table is displayed, Then diff statistics show additions (+) and deletions (-) counts per device
- **AC-012.1**: Given diff output with additions, When displayed in summary, Then addition count is shown in green color
- **AC-012.2**: Given diff output with deletions, When displayed in summary, Then deletion count is shown in red color
- **AC-013**: Given verbose mode, When deployment runs, Then detailed connection and deployment logs are displayed

### Authentication and Security

- **AC-014**: Given inventory with ansible_user in group_vars, When deployment runs, Then credentials are correctly loaded for all devices in group
- **AC-015**: Given inventory with ansible_user in host_vars, When deployment runs, Then host-specific credentials override group credentials
- **AC-016**: Given missing credentials, When deployment is attempted, Then clear error message indicates missing ansible_user or ansible_password
- **AC-017**: Given no flags (default), When connection is established, Then SSL certificate validation is skipped (lab/dev mode)
- **AC-017.1**: Given --verify-ssl flag, When device has invalid certificate, Then connection fails with clear SSL error message
- **AC-017.2**: Given --verify-ssl flag, When device has valid certificate signed by trusted CA, Then connection succeeds
- **AC-017.3**: Given --verify-ssl flag in production, When deployment succeeds, Then no SSL warnings are displayed
- **AC-018**: Given deployment with credentials, When any output is displayed, Then credentials are never shown in logs or console

### Error Handling

- **AC-019**: Given partial deployment failure, When some devices fail, Then successful deployments are not rolled back and summary shows mixed results
- **AC-020**: Given connection timeout, When device is unreachable, Then timeout error is reported and next device is attempted
- **AC-021**: Given invalid configuration syntax, When deployment is attempted, Then EOS validation error is displayed with line number context
- **AC-022**: Given deployment failure in replace mode, When error occurs, Then device configuration state is reported and rollback guidance provided

### Performance

- **AC-023**: Given 10 devices with max-concurrent=10, When deployment runs, Then all devices are deployed in parallel
- **AC-024**: Given 20 devices with max-concurrent=5, When deployment runs, Then deployments are batched with maximum 5 concurrent connections
- **AC-025**: Given async library available, When deployment runs, Then aio-eapi is used for optimal performance
- **AC-026**: Given async library unavailable, When deployment runs, Then fallback to pyeapi with threading is used

## 6. Test Automation Strategy

### Test Levels

- **Unit Tests**: Test individual components in isolation (credential extraction, diff generation, file mapping)
- **Integration Tests**: Test eAPI client interactions with mocked devices
- **End-to-End Tests**: Test full deployment workflow with containerlab or mock EOS devices

### Test Frameworks

- **pytest**: Primary testing framework
- **pytest-asyncio**: Async test support
- **pytest-mock**: Mocking eAPI connections and file operations
- **aioresponses**: Mock async HTTP responses for eAPI

### Test Coverage Areas

```python
# Unit tests
tests/unit/logics/test_deployer.py
    - Test credential extraction from inventory
    - Test config file mapping (hostname -> filename.cfg)
    - Test diff generation logic
    - Test deployment target filtering by groups
    - Test deployment result aggregation

tests/unit/utils/test_eapi_client.py
    - Test eAPI connection initialization
    - Test configuration diff generation
    - Test replace mode configuration application
    - Test merge mode configuration application
    - Test error handling for connection failures

# Integration tests
tests/integration/test_deploy_workflow.py
    - Test full deployment with mocked eAPI responses
    - Test dry-run mode with diff output
    - Test partial failure scenarios
    - Test concurrent deployment behavior
    - Test progress reporting

# E2E tests (optional, requires containerlab)
tests/e2e/test_deploy_e2e.py
    - Test deployment to real cEOS containers
    - Test rollback scenarios
    - Test SSL certificate validation
    - Test authentication with various credential sources
```

### Test Data Management

- Use pytest fixtures for sample inventories with credentials
- Mock eAPI responses for various device states
- Create sample configuration files for testing
- Use temporary directories for test isolation

### CI/CD Integration

- Run unit and integration tests on every commit
- Use GitHub Actions for automated testing
- Mock external dependencies in CI environment
- Generate coverage reports and enforce 80% minimum

### Coverage Requirements

- Minimum 80% code coverage for deploy module
- 100% coverage for credential handling functions (security critical)
- 100% coverage for error handling paths
- Integration tests for all deployment modes

## 7. Rationale & Context

### Why Async/Parallel Deployment?

Network configuration deployment can be time-consuming when performed serially. With potentially dozens or hundreds of devices in an inventory, parallel deployment using async I/O significantly reduces total deployment time. The aio-eapi library provides native async support for Arista eAPI, enabling efficient concurrent connections.

### Why Support Both Replace and Merge Modes?

- **Replace Mode**: Provides full configuration synchronization, ensuring device config matches intended state exactly. Best for initial provisioning or major config changes.
- **Merge Mode**: Allows incremental updates without disrupting existing configuration. Better for operational changes where full config replacement is too disruptive.

### Why Dry-Run Mode?

Dry-run mode is essential for safe operations in production networks. It allows operators to validate intended changes before applying them, catching syntax errors, logic issues, or unintended consequences. This follows the principle of "test before apply" common in infrastructure-as-code workflows.

### Why Read Credentials from Inventory?

Ansible inventory is already the source of truth for device management credentials in AVD workflows. Reusing these credentials maintains consistency with existing automation and avoids credential duplication. This also supports existing security practices around Ansible Vault for credential encryption.

### Why Support Custom Configs Path?

While defaulting to `intended/configs` aligns with AVD conventions, users may need flexibility for testing scenarios, multi-tenant deployments, or custom workflows. The optional configs path parameter supports these use cases while maintaining sensible defaults.

### Why Limit Concurrent Connections?

Unlimited concurrent connections could overwhelm devices or network infrastructure. The configurable max-concurrent parameter allows users to tune behavior based on:
- Device CPU/memory capacity
- Network bandwidth constraints
- Management plane load balancing
- Organizational change control policies

### Why Remove Per-Device Progress Bars? (v1.1 Update)

**Previous Behavior**: Individual progress bars were displayed for each device during deployment, creating visual clutter with multiple concurrent deployments.

**New Behavior**: Summary table with deployment status replaces per-device progress bars, providing cleaner output and better readability.

**Rationale**:
- **Reduced Visual Clutter**: With 10-50+ devices deploying concurrently, multiple progress bars create confusing, hard-to-read output
- **Better Information Density**: Summary table provides more actionable information (status, duration, diff stats) in less vertical space
- **Improved Scanning**: Table format allows users to quickly identify failures or anomalies
- **Real-time Updates**: Status table updates in real-time as devices complete, maintaining visibility without progress bar noise
- **Professional Appearance**: Clean table output aligns with enterprise automation tool expectations

### Why Add Diff Statistics to Summary Table? (v1.1 Update)

**New Feature**: Summary table now includes columns showing the number of lines added (+) and removed (-) in green and red respectively.

**Rationale**:
- **Change Impact Visibility**: Operators can quickly assess the scope of changes per device at a glance
- **Anomaly Detection**: Devices with unexpectedly high diff counts (e.g., +500 / -200) stand out immediately, indicating potential issues
- **Audit Trail**: Diff statistics provide quantitative change metrics for documentation and compliance
- **Color Coding**: Green (+) and red (-) colors provide intuitive visual cues matching standard diff conventions
- **Deployment Confidence**: Seeing expected diff counts (e.g., +3 / -0 for a minor change) increases operator confidence before applying changes
- **Post-Deployment Review**: Statistics remain visible in the summary for review and logging purposes

**Example Use Cases**:
- **Sanity Check**: "I expect to add 5 VLAN lines, why does this show +50?"
- **Comparison**: "Spine01 shows +12 / -2, but Spine02 shows +45 / -30 - investigate Spine02"
- **Documentation**: "Deployment added 120 lines and removed 15 lines across 24 devices"

## 8. Dependencies & External Integrations

### External Systems

- **EXT-001**: Arista EOS Devices - Target network devices with eAPI enabled (HTTPS on port 443)
- **EXT-002**: AVD Inventory - File-based Ansible inventory containing device definitions and credentials
- **EXT-003**: Generated Configurations - Configuration files produced by `avd-cli generate` command

### Third-Party Services

- **SVC-001**: None - Command operates entirely with local files and direct device API calls

### Infrastructure Dependencies

- **INF-001**: Network Connectivity - IP reachability to device management interfaces on eAPI port (typically 443)
- **INF-002**: Python Async Runtime - Python 3.9+ with asyncio support
- **INF-003**: SSL/TLS - HTTPS connectivity with configurable certificate validation
  - Default: SSL certificate verification disabled (lab/dev friendly, accepts self-signed certs)
  - Optional: SSL verification can be enabled via --verify-ssl flag for production
  - Recommended: Use --verify-ssl with valid CA-signed certificates in production environments

### Data Dependencies

- **DAT-001**: Ansible Inventory Variables - `ansible_user` and `ansible_password` in group_vars or host_vars
- **DAT-002**: Configuration Files - Valid EOS CLI configuration syntax in .cfg files
- **DAT-003**: Device Hostnames - Consistent hostname mapping between inventory and config filenames

### Technology Platform Dependencies

- **PLT-001**: aio-eapi Library - Async Python library for Arista eAPI (preferred)
  - Rationale: Native async support for optimal performance
  - Fallback: pyeapi library if aio-eapi unavailable
  - Installation: `pip install aio-eapi`
  - Repository: https://github.com/jeremyschulman/aio-eapi
- **PLT-002**: pyeapi Library - Synchronous Python library for Arista eAPI (fallback)
  - Rationale: Official Arista library with broad compatibility
  - Installation: `pip install pyeapi`
  - Repository: https://github.com/arista-eosplus/pyeapi
- **PLT-003**: EOS eAPI - Arista EOS devices must have eAPI enabled
  - Minimum version: EOS 4.20+ recommended
  - Authentication: Username/password or certificate-based
  - Configuration: `management api http-commands` required
  - SSL Certificates:
    - Lab/Dev: Self-signed certificates work by default (no verification)
    - Production: Use --verify-ssl flag with CA-signed certificates for secure communication
    - Certificate validation (when enabled) uses system CA trust store
- **PLT-004**: Rich Library - Terminal UI library for progress bars and status display
  - Required for consistent CLI experience
  - Already a project dependency

### Compliance Dependencies

- **COM-001**: Network Change Control - Deployments should align with organizational change management policies
  - Impact: Dry-run mode facilitates pre-approval validation
  - Recommendation: Integrate deployment logs with change ticketing systems

### Optional Dependencies

- **OPT-001**: Ansible Vault - For encrypted credential storage in inventory
  - Support for vault-encrypted variables
  - Requires ansible-vault command-line tool availability

## 9. Examples & Edge Cases

### Basic Deployment Examples

```bash
# Deploy all configurations with replace mode (default)
avd-cli deploy eos -i ./inventory

# Expected output:
# → Loading inventory...
# ✓ Loaded 24 devices
# → Loading configurations from ./inventory/intended/configs
# ✓ Found 24 configuration files
# → Deploying configurations in replace mode...
#
# Deployment Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status    ┃ Duration  ┃ Diff (+/-)      ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
# │ spine01     │ ✓ Success │ 2.3s      │ +15 / -3        │
# │ spine02     │ ✓ Success │ 2.1s      │ +12 / -2        │
# │ leaf01      │ ✓ Success │ 3.2s      │ +45 / -10       │
# │ leaf02      │ ✓ Success │ 2.9s      │ +42 / -8        │
# │ leaf03      │ ✓ Success │ 2.8s      │ +38 / -7        │
# │ leaf04      │ ✓ Success │ 3.1s      │ +40 / -9        │
# │ ...         │ ...       │ ...       │ ...             │
# └─────────────┴───────────┴───────────┴─────────────────┘
#
# Note: +15 indicates additions (shown in green), -3 indicates deletions (shown in red)
#
# Deployment Summary
# ┏━━━━━━━━━━━━━━━┳━━━━━━━┓
# ┃ Metric        ┃ Count ┃
# ┡━━━━━━━━━━━━━━━╇━━━━━━━┩
# │ Total         │ 24    │
# │ Success       │ 24    │
# │ Failed        │ 0     │
# │ Skipped       │ 0     │
# │ Total Duration│ 45.2s │
# └───────────────┴───────┘
```

### Dry-Run Mode Example

```bash
# Preview changes without applying
avd-cli deploy eos -i ./inventory --dry-run

# Expected output:
# → Loading inventory...
# ✓ Loaded 24 devices
# → Loading configurations from ./inventory/intended/configs
# ✓ Found 24 configuration files
# → Running in dry-run mode (no changes will be applied)
# → Generating configuration diffs...
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Device: spine01 (192.168.0.10)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# --- running-config
# +++ intended-config
# @@ -45,6 +45,9 @@
#  interface Ethernet1
#     description Connected to leaf01
#     no switchport
# +!
# +interface Ethernet3
# +   description Connected to leaf03
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Device: spine02 (192.168.0.11)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# --- running-config
# +++ intended-config
# @@ -50,3 +50,6 @@
#  interface Ethernet2
#     description Connected to leaf02
#     no switchport
# +!
# +interface Ethernet3
# +   description Connected to leaf03
#
# ✓ Dry-run complete - no changes applied
```

### Merge Mode Deployment

```bash
# Deploy using merge mode with diff output
avd-cli deploy eos -i ./inventory --merge --diff

# Expected output:
# → Loading inventory...
# ✓ Loaded 10 devices
# → Deploying configurations in merge mode...
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Deploying to spine01 (192.168.0.10)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# +interface Ethernet3
# +   description Connected to leaf03
# +   no switchport
# ✓ Successfully deployed to spine01 (2.1s)
#
# [Similar output for other devices...]
#
# Deployment Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status    ┃ Duration  ┃ Diff (+/-)      ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
# │ spine01     │ ✓ Success │ 2.1s      │ +3 / -0         │
# │ spine02     │ ✓ Success │ 2.0s      │ +3 / -0         │
# │ leaf01      │ ✓ Success │ 2.3s      │ +8 / -2         │
# │ leaf02      │ ✓ Success │ 2.2s      │ +7 / -1         │
# │ ...         │ ...       │ ...       │ ...             │
# └─────────────┴───────────┴───────────┴─────────────────┘
#
# Note: Numbers in green (+) indicate additions, in red (-) indicate deletions
#
# Deployment Summary
# ┏━━━━━━━━━━━━━━━┳━━━━━━━┓
# ┃ Metric        ┃ Count ┃
# ┡━━━━━━━━━━━━━━━╇━━━━━━━┩
# │ Total         │ 10    │
# │ Success       │ 10    │
# │ Failed        │ 0     │
# │ Skipped       │ 0     │
# │ Total Duration│ 18.4s │
# └───────────────┴───────┘
```

### Group-Limited Deployment

```bash
# Deploy only spine devices
avd-cli deploy eos -i ./inventory -l SPINES

# Expected output:
# → Loading inventory...
# ✓ Loaded 24 devices
# ℹ Limiting deployment to groups: SPINES
# ✓ Selected 2 devices for deployment
# → Loading configurations from ./inventory/intended/configs
# → Deploying configurations in replace mode...
#
# Deployment Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status    ┃ Duration  ┃ Diff (+/-)      ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
# │ spine01     │ ✓ Success │ 2.3s      │ +15 / -3        │
# │ spine02     │ ✓ Success │ 2.1s      │ +12 / -2        │
# └─────────────┴───────────┴───────────┴─────────────────┘
```

### SSL Certificate Verification Examples

#### Without SSL Verification (Default - Lab/Dev Friendly)

```bash
# Deploy without SSL certificate verification (default - suitable for lab/dev)
avd-cli deploy eos -i ./inventory

# Expected output with any certificates (self-signed or CA-signed):
# → Loading inventory...
# ✓ Loaded 10 devices
# → Deploying configurations in replace mode...
# → SSL certificate verification: disabled (use --verify-ssl for production)
#
# Deployment Progress
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 10/10 devices
#
# Device Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status  ┃ Duration  ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━┩
# │ spine01     │ ✓ Success │ 2.3s    │
# │ spine02     │ ✓ Success │ 2.1s    │
# │ ...         │ ...       │ ...     │
# └─────────────┴───────────┴─────────┘
```

#### With SSL Verification (Production - Recommended)

```bash
# Deploy with SSL certificate verification enabled (production mode)
avd-cli deploy eos -i ./inventory --verify-ssl

# Expected output with valid CA-signed certificates:
# → Loading inventory...
# ✓ Loaded 10 devices
# → Deploying configurations in replace mode...
# → SSL certificate verification: enabled
# ✓ All devices deployed successfully

# Expected output with invalid/self-signed certificates:
# → Loading inventory...
# ✓ Loaded 10 devices
# → Deploying configurations in replace mode...
# → SSL certificate verification: enabled
#
# Device Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status                             ┃ Duration  ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━┩
# │ spine01     │ ✗ SSL certificate verification failed │ 0.5s   │
# │ spine02     │ ✗ SSL certificate verification failed │ 0.5s   │
# └─────────────┴────────────────────────────────────┴───────────┘
#
# Failed Devices:
# • spine01: SSL certificate verification failed
#   - Certificate is self-signed or not trusted
#   - Options:
#     1. Install proper CA-signed certificate on device
#     2. Add CA certificate to system trust store
#     3. Remove --verify-ssl flag for lab/dev deployment (default behavior)
```

### Error Scenarios

#### Missing Configuration File

```bash
avd-cli deploy eos -i ./inventory

# Expected output:
# → Loading inventory...
# ✓ Loaded 10 devices
# → Loading configurations from ./inventory/intended/configs
# ✗ Error: Configuration file not found for leaf03
#   Expected: ./inventory/intended/configs/leaf03.cfg
#   Available files: spine01.cfg, spine02.cfg, leaf01.cfg, leaf02.cfg
#
# Suggestion: Run 'avd-cli generate configs -i ./inventory' to generate missing configurations
```

#### Authentication Failure

```bash
avd-cli deploy eos -i ./inventory

# Expected output:
# → Loading inventory...
# ✓ Loaded 10 devices
# → Deploying configurations...
#
# Deployment Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status                     ┃ Duration  ┃ Diff (+/-)      ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
# │ spine01     │ ✗ Authentication failed    │ 1.2s      │ -               │
# │ spine02     │ ✓ Success                  │ 2.1s      │ +12 / -2        │
# │ leaf01      │ ✓ Success                  │ 3.2s      │ +45 / -10       │
# └─────────────┴────────────────────────────┴───────────┴─────────────────┘
#
# Deployment Summary
# ┏━━━━━━━━━━━━━━━┳━━━━━━━┓
# ┃ Metric        ┃ Count ┃
# ┡━━━━━━━━━━━━━━━╇━━━━━━━┩
# │ Total         │ 3     │
# │ Success       │ 2     │
# │ Failed        │ 1     │
# │ Skipped       │ 0     │
# └───────────────┴───────┘
#
# Failed Devices:
# • spine01: Authentication failed - verify ansible_user and ansible_password in inventory
```

#### Connection Timeout

```bash
avd-cli deploy eos -i ./inventory --timeout 10

# Expected output:
# → Loading inventory...
# ✓ Loaded 5 devices
# → Deploying configurations...
#
# Deployment Status
# ┏━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┓
# ┃ Hostname    ┃ Status                          ┃ Duration  ┃ Diff (+/-)      ┃
# ┡━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━┩
# │ spine01     │ ✗ Connection timeout (10s)      │ 10.1s     │ -               │
# │ spine02     │ ✓ Success                       │ 2.3s      │ +12 / -2        │
# └─────────────┴─────────────────────────────────┴───────────┴─────────────────┘
#
# Failed Devices:
# • spine01: Connection timeout after 10 seconds
#   - Verify device is reachable: ping 192.168.0.10
#   - Verify eAPI is enabled: show management api http-commands
#   - Try increasing timeout: --timeout 30
```

### Environment Variables Example

```bash
# Configure deployment via environment variables
export AVD_CLI_INVENTORY_PATH=./inventory
export AVD_CLI_CONFIGS_PATH=./custom-configs
export AVD_CLI_MERGE_MODE=true
export AVD_CLI_DRY_RUN=false
export AVD_CLI_SHOW_DIFF=true
export AVD_CLI_MAX_CONCURRENT=5
export AVD_CLI_TIMEOUT=60
export AVD_CLI_VERIFY_SSL=true  # Enable for production

# Run deployment with all settings from environment
avd-cli deploy eos

# Expected output:
# → Loading inventory from $AVD_CLI_INVENTORY_PATH...
# ✓ Loaded 10 devices
# → Loading configurations from $AVD_CLI_CONFIGS_PATH...
# → Deploying in merge mode with diff output...
# [Deployment proceeds with configured settings]
```

### Complex Workflow Example

```bash
# 1. Generate configurations
avd-cli generate configs -i ./inventory

# 2. Preview changes in dry-run
avd-cli deploy eos -i ./inventory --dry-run > deployment-preview.txt

# 3. Review diff and approve
cat deployment-preview.txt

# 4. Deploy to spines first (canary deployment)
avd-cli deploy eos -i ./inventory -l SPINES --diff

# 5. If successful, deploy to leafs
avd-cli deploy eos -i ./inventory -l LEAFS --diff

# 6. Verify deployment
avd-cli info -i ./inventory -f table
```

## 10. Validation Criteria

### Functional Validation

- **VAL-001**: Configuration files must exist for all targeted devices before deployment starts
- **VAL-002**: Credentials (ansible_user, ansible_password) must be present in inventory for each device
- **VAL-003**: Device management IP must be reachable on eAPI port before attempting connection
- **VAL-004**: Configuration syntax must be valid EOS CLI format
- **VAL-005**: Dry-run diff output must match actual deployment diff
- **VAL-006**: Replace mode must result in device config exactly matching intended config
- **VAL-007**: Merge mode must only add/remove specified configuration lines

### Performance Validation

- **VAL-008**: Parallel deployment must complete in O(n/max_concurrent) time complexity
- **VAL-009**: Progress bar must update in real-time with <1 second lag
- **VAL-010**: Memory usage must remain bounded regardless of device count
- **VAL-011**: Connection pooling must reuse connections when possible

### Security Validation

- **VAL-012**: Credentials must never appear in console output or logs
- **VAL-013**: SSL certificate validation must be configurable and work correctly in both modes
- **VAL-013.1**: Default mode (no --verify-ssl) must accept self-signed and CA-signed certificates
- **VAL-013.2**: SSL verification enabled (--verify-ssl) must reject self-signed certificates
- **VAL-013.3**: SSL verification enabled (--verify-ssl) must accept certificates signed by system-trusted CAs
- **VAL-014**: Authentication failures must not leak credential information in error messages
- **VAL-015**: Diff output must not contain sensitive data (use sanitization patterns)

### Reliability Validation

- **VAL-016**: Failed deployments must not affect subsequent device deployments
- **VAL-017**: Connection timeout must be honored and not block indefinitely
- **VAL-018**: Retry logic must handle transient failures with exponential backoff
- **VAL-019**: Command must exit with non-zero code if any deployments fail

### Usability Validation

- **VAL-020**: Error messages must include device context (hostname, IP)
- **VAL-021**: Error messages must provide actionable remediation steps
- **VAL-022**: Summary table must clearly show deployment results without per-device loading bars
- **VAL-023**: Summary output must provide sufficient detail for audit purposes including diff statistics
- **VAL-024**: Diff statistics in summary must use color coding (green for additions, red for deletions)
- **VAL-025**: Summary table must include columns for device status, duration, and diff line counts

## 11. Related Specifications / Further Reading

### Internal Specifications

- [AVD CLI Tool Architecture Specification](./tool-avd-cli-architecture.md)
- [AVD Inventory Schema Specification](./data-avd-inventory-schema.md)
- [AVD Workflow Process Specification](./process-avd-workflow.md)

### External Documentation

- [Arista eAPI Documentation](https://www.arista.com/en/um-eos/eos-section-24-1-eapi-overview)
- [aio-eapi Library](https://github.com/jeremyschulman/aio-eapi)
- [pyeapi Library](https://github.com/arista-eosplus/pyeapi)
- [Arista AVD Documentation](https://avd.arista.com/)
- [asyncio Documentation](https://docs.python.org/3/library/asyncio.html)
- [Rich Library Documentation](https://rich.readthedocs.io/)
- [Click Documentation](https://click.palletsprojects.com/)
- [Ansible Inventory Documentation](https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html)

---

<!-- End of Deploy EOS Command Specification -->
